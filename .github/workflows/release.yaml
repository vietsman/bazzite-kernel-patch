name: Build & Publish AMDGPU Module

on:
  push:
    branches:
      - main  # Change to your default branch if needed

jobs:
  build:
    runs-on: ubuntu-latest
    container:
      image: fedora:42
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Detect latest Fedora 42 kernel (x86_64)
        id: detect
        run: |
          set -euo pipefail
          NEVRA=$(dnf repoquery --latest-limit=1 --arch=x86_64 \
            --qf '%{name}-%{version}-%{release}.%{arch}' kernel-core)
          KVER="${NEVRA#kernel-core-}"
          echo "kernel_version=${KVER}" >> $GITHUB_OUTPUT
          echo "Detected kernel: ${KVER}"

      - name: Install build dependencies
        run: |
          dnf install -y dnf-plugins-core
          dnf install -y make gcc elfutils-libelf-devel \
            kernel-devel-${{ steps.detect.outputs.kernel_version }}

      - name: Patch AMDGPU driver
        run: |
          # Example patch commands
          sed -i 's/#define[[:space:]]\+CYAN_SKILLFISH_SCLK_MIN[[:space:]]\+1000/#define CYAN_SKILLFISH_SCLK_MIN 350/' \
              drivers/gpu/drm/amd/pm/swsmu/smu11/cyan_skillfish_ppt.c
          sed -i 's/#define[[:space:]]\+CYAN_SKILLFISH_SCLK_MAX[[:space:]]\+2000/#define CYAN_SKILLFISH_SCLK_MAX 2230/' \
              drivers/gpu/drm/amd/pm/swsmu/smu11/cyan_skillfish_ppt.c

      - name: Build AMDGPU module
        run: |
          KVER="${{ steps.detect.outputs.kernel_version }}"
          make -C /lib/modules/$KVER/build \
            M=$(pwd)/drivers/gpu/drm/amd/amdgpu modules

      - name: Prepare artifact directory
        run: |
          mkdir -p /tmp/artifacts
          cp drivers/gpu/drm/amd/amdgpu/*.ko /tmp/artifacts/

      - name: Upload artifact (optional, for debugging)
        uses: actions/upload-artifact@v4
        with:
          name: amdgpu-patched-${{ steps.detect.outputs.kernel_version }}
          path: /tmp/artifacts/*.ko

      - name: Create or update GitHub Release
        uses: ncipollo/release-action@v1
        with:
          tag: "amdgpu-${{ steps.detect.outputs.kernel_version }}"
          name: "Patched AMDGPU for kernel ${{ steps.detect.outputs.kernel_version }}"
          artifacts: /tmp/artifacts/*.ko
          draft: false
          prerelease: false
