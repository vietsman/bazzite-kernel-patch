name: Build Patched AMDGPU (Fedora 42 x86_64, headers only)

on:
  workflow_dispatch: {}

jobs:
  build-amdgpu:
    runs-on: ubuntu-latest
    container:
      image: fedora:42
    steps:
      - name: Prep shell
        run: |
          set -euo pipefail

      - name: Install build dependencies
        run: |
          dnf -y install \
            gcc make \
            elfutils-libelf-devel \
            rpm-build rpmdevtools \
            git tar xz \
            kernel-devel kernel

      - name: Detect running kernel version
        id: detect
        run: |
          KVER=$(uname -r)
          echo "kernel_version=${KVER}" >> $GITHUB_OUTPUT
          echo "Detected kernel: ${KVER}"

      - name: Copy minimal AMDGPU module + smu11 and apply patch
        run: |
          KVER="${{ steps.detect.outputs.kernel_version }}"
          mkdir -p /tmp/amdgpu-src/pm/swsmu
          cp -r /usr/src/kernels/${KVER}/drivers/gpu/drm/amd/amdgpu /tmp/amdgpu-src/
          cp -r /usr/src/kernels/${KVER}/drivers/gpu/drm/amd/pm/swsmu/smu11 /tmp/amdgpu-src/pm/swsmu/
          sed -i 's/#define[[:space:]]\+CYAN_SKILLFISH_SCLK_MIN[[:space:]]\+1000/#define CYAN_SKILLFISH_SCLK_MIN 350/' \
            /tmp/amdgpu-src/pm/swsmu/smu11/cyan_skillfish_ppt.c
          sed -i 's/#define[[:space:]]\+CYAN_SKILLFISH_SCLK_MAX[[:space:]]\+2000/#define CYAN_SKILLFISH_SCLK_MAX 2230/' \
            /tmp/amdgpu-src/pm/swsmu/smu11/cyan_skillfish_ppt.c

      - name: Build AMDGPU module against kernel headers
        run: |
          KVER="${{ steps.detect.outputs.kernel_version }}"
          make -C /lib/modules/${KVER}/build M=/tmp/amdgpu-src modules
          test -f /tmp/amdgpu-src/amdgpu/amdgpu.ko

      - name: Create minimal RPM spec
        run: |
          cat > ~/rpmbuild/SPECS/amdgpu-patched.spec <<'EOF'
          Name:           amdgpu-patched
          Version:        1.0
          Release:        1%{?dist}
          Summary:        Patched AMDGPU kernel module (cyan_skillfish clocks)
          License:        GPLv2
          BuildArch:      x86_64
          Requires:       kernel-modules >= 0

          %description
          Minimal AMDGPU module built against Fedora kernel headers with patched cyan_skillfish SCLK limits.

          %global kver %{?kernel_version}

          %prep

          %build

          %install
          mkdir -p %{buildroot}/lib/modules/%{kver}/extra/amdgpu
          install -m 0644 /tmp/amdgpu-src/amdgpu/amdgpu.ko %{buildroot}/lib/modules/%{kver}/extra/amdgpu/
          /usr/sbin/strip --strip-debug %{buildroot}/lib/modules/%{kver}/extra/amdgpu/amdgpu.ko || :

          %post
          /sbin/depmod -a %{kver} || :

          %files
          /lib/modules/%{kver}/extra/amdgpu/amdgpu.ko

          %changelog
          * Thu Aug 14 2025 CI <ci@example.invalid> - 1.0-1
          - Minimal build against kernel headers
          EOF

      - name: Build RPM
        run: |
          KVER="${{ steps.detect.outputs.kernel_version }}"
          rpmbuild -bb --define "kernel_version ${KVER}" ~/rpmbuild/SPECS/amdgpu-patched.spec
          mkdir -p /artifacts
          cp ~/rpmbuild/RPMS/x86_64/amdgpu-patched-*.rpm /artifacts/

      - name: Upload RPM artifact
        uses: actions/upload-artifact@v4
        with:
          name: amdgpu-patched-rpm
          path: /artifacts/*.rpm
